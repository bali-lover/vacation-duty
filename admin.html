<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방학 중 복무 관리 - 담당자용 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .date-grid {
            display: grid;
            grid-template-columns: 138px repeat(51, 40px);
            gap: 2px;
            margin-bottom: 20px;
            min-width: max-content;
        }

        .date-header {
            display: contents;
        }

        .teacher-name {
            background: white;
            color: #333;
            padding: 8px;
            font-weight: bold;
            font-size: 12px;
            border-radius: 6px;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 10;
            min-width: 138px;
            max-width: 138px;
            border: 2px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .teacher-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .teacher-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: normal;
            white-space: nowrap;
        }

        .checkbox-row input[type="checkbox"] {
            width: 12px;
            height: 12px;
        }

        .date-cell {
            background: white;
            border: 2px solid #ccc;
            padding: 4px;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            min-height: 50px;
            min-width: 40px;
            max-width: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-radius: 4px;
            color: #333;
        }

        .date-number {
            font-size: 11px;
            color: #374151;
            margin-bottom: 2px;
        }

        .date-day {
            font-size: 9px;
            color: #6b7280;
        }

        .weekend {
            background: #fef2f2;
            color: #dc2626;
        }

        .holiday {
            background: #fef2f2;
            color: #dc2626;
            font-weight: bold;
        }

        .duty-cell {
            min-height: 40px;
            min-width: 40px;
            max-width: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            border: 2px solid;
            color: #333;
        }

        .duty-41 {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .duty-work {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196F3;
        }

        .duty-business {
            background: rgba(255, 152, 0, 0.3);
            border-color: #FF9800;
        }

        .duty-vacation {
            background: rgba(244, 67, 54, 0.3);
            border-color: #F44336;
        }

        .duty-overseas {
            background: rgba(156, 39, 176, 0.3);
            border-color: #9C27B0;
        }

        .duty-weekend-excluded {
            background: rgba(200, 200, 200, 0.2);
            border-color: #999;
            border-style: dashed;
            opacity: 0.7;
            color: #666;
        }

        /* 혼합 복무 유형 스타일 */
        .duty-mixed {
            position: relative;
            overflow: hidden;
            background: white;
            border: 2px solid #ccc;
        }

        .duty-mixed:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .mixed-duty-label {
            font-size: 8px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            padding: 1px 2px;
            border-radius: 2px;
            line-height: 1.2;
        }

        /* 툴팁 스타일 */
        .duty-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            pointer-events: none;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .duty-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #2d3748;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            color: #60d1fa;
        }

        .tooltip-time-slot {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tooltip-time {
            color: #a0aec0;
            font-family: 'Courier New', monospace;
        }

        .tooltip-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
        }

        /* 빗금 무늬 스타일 */
        .checked-by-admin {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 3px,
                rgba(0, 0, 0, 0.3) 3px,
                rgba(0, 0, 0, 0.3) 6px
            ) !important;
        }

        .checked-by-research {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 3px,
                rgba(0, 0, 0, 0.3) 3px,
                rgba(0, 0, 0, 0.3) 6px
            ) !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 8px;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 3px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(37,99,235,0.3);
        }

        .firebase-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .firebase-connected {
            background: #d4edda;
            color: #155724;
        }

        .firebase-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scroll-container {
            overflow-x: auto;
            overflow-y: visible;
            width: 100%;
            padding-bottom: 10px;
        }

        .legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .department-section {
            margin-bottom: 30px;
        }

        .department-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .department-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 10px 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-top: none;
        }

        .department-grid {
            display: grid;
            grid-template-columns: 138px repeat(51, 40px);
            gap: 2px;
            padding: 15px;
            min-width: max-content;
        }

        .no-teachers {
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        .department-row {
            background: #374151;
            color: white;
            padding: 8px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            border-radius: 6px;
            grid-column: 1 / -1;
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <h1 class="text-2xl font-bold">🏫 방학 중 복무 관리 대시보드</h1>
                <div style="display: flex; align-items: center;">
                    <span class="text-sm text-gray-500" id="last-updated">마지막 업데이트: -</span>
                    <button class="btn ml-4" onclick="refreshData()">🔄 새로고침</button>
                    <span id="firebase-status" class="firebase-status firebase-disconnected">Firebase 연결 중...</span>
                    <button onclick="showFirebaseSettings()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">⚙️ Firebase 설정</button>
                </div>
            </div>
        </div>


        <!-- 날짜별 복무 현황 -->
        <div class="card">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-xl font-bold">📅 날짜별 복무 현황</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color duty-41"></div>
                        <span>41조</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color duty-work"></div>
                        <span>근무</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color duty-business"></div>
                        <span>출장</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color duty-vacation"></div>
                        <span>연가</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color duty-overseas"></div>
                        <span>국외</span>
                    </div>
                    <button onclick="deleteSelectedTeachers()" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px;">🗑️ 선택 삭제</button>
                </div>
            </div>

            <div class="scroll-container">
                <div id="main-grid" class="date-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>데이터를 불러오는 중...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase 설정 모달 -->
    <div id="firebaseModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">🔧 Firebase 설정</h2>
            <div id="savedSettingsInfo" style="display: none; background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 1rem;">
                저장된 설정이 있습니다. 필요시 수정해주세요.
            </div>
            <div style="margin-bottom: 1rem;">
                <label for="firebaseApiKey" style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Firebase API Key:</label>
                <input type="password" id="firebaseApiKey" placeholder="Firebase API Key 입력" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="firebaseProjectId" style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Firebase Project ID:</label>
                <input type="text" id="firebaseProjectId" placeholder="Project ID 입력" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px;">
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="saveFirebaseSettings()" style="flex: 1; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white;">설정 저장</button>
                <button onclick="closeFirebaseModal()" style="flex: 1; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: #6c757d; color: white;">취소</button>
            </div>
        </div>
    </div>

    <script>
        class AdminDashboard {
            constructor() {
                this.firebaseEnabled = false;
                this.database = null;
                this.vacationStart = new Date(2026, 0, 9); // 2026년 1월 9일
                this.vacationEnd = new Date(2026, 1, 28);   // 2026년 2월 28일
                this.holidays = [
                    new Date(2026, 0, 1),  // 신정
                    new Date(2026, 1, 16), // 설날 전날
                    new Date(2026, 1, 17), // 설날
                    new Date(2026, 1, 18)  // 설날 다음날
                ];
                this.allSettings = {};
                this.teachers = new Map();
                this.departments = [
                    '교무기획부',
                    '미래교육연구부',
                    '생활안전인권부',
                    '진로상담부',
                    '학생자치부',
                    '과학정보부',
                    '인문복지부',
                    '교육과정부',
                    '문화예술체육부',
                    '1학년부',
                    '2학년부',
                    '3학년부'
                ];

                this.initFirebase();
            }

            initFirebase() {
                try {
                    // localStorage에서 설정 불러오기
                    const apiKey = localStorage.getItem('firebase_apiKey');
                    const projectId = localStorage.getItem('firebase_projectId');

                    if (!apiKey || !projectId) {
                        console.warn('Firebase 설정 없음 - 테스트 데이터 사용');
                        this.firebaseEnabled = false;
                        this.updateFirebaseStatus(false);
                        this.loadTestData();
                        return;
                    }

                    const firebaseConfig = {
                        apiKey: apiKey,
                        authDomain: `${projectId}.firebaseapp.com`,
                        databaseURL: `https://${projectId}-default-rtdb.asia-southeast1.firebasedatabase.app`,
                        projectId: projectId,
                        storageBucket: `${projectId}.firebasestorage.app`,
                        messagingSenderId: "383693605457",
                        appId: "1:383693605457:web:b5c75a08b0fcef08188670"
                    };

                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    this.database = firebase.database();

                    // 연결 테스트
                    this.database.ref('.info/connected').on('value', (snapshot) => {
                        if (snapshot.val() === true) {
                            console.log('✅ Firebase 연결 성공');
                            this.firebaseEnabled = true;
                            this.updateFirebaseStatus(true);
                            this.loadFromFirebase();
                        } else {
                            console.log('❌ Firebase 연결 끊어짐');
                            this.firebaseEnabled = false;
                            this.updateFirebaseStatus(false);
                        }
                    });

                } catch (error) {
                    console.warn('Firebase 초기화 실패:', error);
                    this.firebaseEnabled = false;
                    this.updateFirebaseStatus(false);
                    this.loadTestData();
                }
            }

            loadFromFirebase() {
                if (!this.firebaseEnabled || !this.database) return;

                const vacationDutyRef = this.database.ref('vacation-duty');

                // 실시간 동기화
                vacationDutyRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.allSettings = data;
                        console.log('Firebase 데이터 로드:', Object.keys(data).length, '명');
                        this.updateDisplay();
                    } else {
                        console.log('Firebase 데이터 없음');
                        this.loadTestData();
                    }
                });
            }

            updateFirebaseStatus(connected) {
                const statusElement = document.getElementById('firebase-status');
                if (connected) {
                    statusElement.textContent = '🟢 Firebase 연결됨';
                    statusElement.className = 'firebase-status firebase-connected';
                } else {
                    statusElement.textContent = '🔴 Firebase 연결 안됨';
                    statusElement.className = 'firebase-status firebase-disconnected';
                }
            }

            loadTestData() {
                // 테스트용 데이터 5명의 가상 교사
                this.allSettings = {
                    '김철수_교무기획부': {
                        name: '김철수',
                        department: '교무기획부',
                        dutySchedule: {
                            '2026-01-09': '41',
                            '2026-01-10': 'vacation',
                            '2026-01-11': 'work',        // 토요일
                            '2026-01-12': 'business',    // 일요일
                            '2026-01-13': 'vacation',
                            '2026-01-14': 'overseas',
                            '2026-01-15': 'mixed',       // 혼합 복무
                            '2026-01-16': '41',
                            '2026-01-17': 'mixed',       // 혼합 복무
                            '2026-01-18': 'work',        // 토요일
                            '2026-01-19': 'vacation',    // 일요일
                            '2026-01-20': 'business',
                            '2026-01-21': 'business'
                        },
                        detailSchedule: {
                            '2026-01-15': [
                                { start: '08:40', end: '12:00', type: '41' },
                                { start: '13:00', end: '16:40', type: 'business' }
                            ],
                            '2026-01-17': [
                                { start: '08:40', end: '10:00', type: 'vacation' },
                                { start: '10:00', end: '16:40', type: 'overseas' }
                            ]
                        }
                    },
                    '이영희_미래교육연구부': {
                        name: '이영희',
                        department: '미래교육연구부',
                        dutySchedule: {
                            '2026-01-09': 'business',
                            '2026-01-10': 'business',
                            '2026-01-11': 'overseas',    // 토요일
                            '2026-01-12': 'work',        // 일요일
                            '2026-01-13': '41',
                            '2026-01-14': '41',
                            '2026-01-15': 'work',
                            '2026-01-16': 'work',
                            '2026-01-18': 'business',    // 토요일
                            '2026-01-19': 'vacation',    // 일요일
                            '2026-01-20': 'vacation',
                            '2026-01-21': 'vacation'
                        }
                    },
                    '박민수_교무기획부': {
                        name: '박민수',
                        department: '교무기획부',
                        dutySchedule: {
                            '2026-01-09': '41',
                            '2026-01-10': '41',
                            '2026-01-11': 'vacation',    // 토요일
                            '2026-01-12': 'overseas',    // 일요일
                            '2026-01-13': 'work',
                            '2026-01-14': 'mixed',       // 혼합 복무 (3개 유형)
                            '2026-01-15': '41',
                            '2026-01-16': 'overseas',
                            '2026-01-18': 'overseas',    // 토요일
                            '2026-01-19': 'business',    // 일요일
                            '2026-01-20': 'overseas',
                            '2026-01-21': '41'
                        },
                        detailSchedule: {
                            '2026-01-14': [
                                { start: '08:40', end: '10:30', type: 'vacation' },
                                { start: '10:30', end: '14:00', type: '41' },
                                { start: '14:00', end: '16:40', type: 'work' }
                            ]
                        }
                    },
                    '최지수_1학년부': {
                        name: '최지수',
                        department: '1학년부',
                        dutySchedule: {
                            '2026-01-09': 'overseas',
                            '2026-01-10': 'overseas',
                            '2026-01-11': '41',          // 토요일
                            '2026-01-12': 'vacation',    // 일요일
                            '2026-01-13': 'overseas',
                            '2026-01-14': '41',
                            '2026-01-15': '41',
                            '2026-01-16': 'business',
                            '2026-01-18': 'vacation',    // 토요일
                            '2026-01-19': 'work',        // 일요일
                            '2026-01-20': 'work',
                            '2026-01-21': 'vacation'
                        }
                    },
                    '정미경_2학년부': {
                        name: '정미경',
                        department: '2학년부',
                        dutySchedule: {
                            '2026-01-09': 'work',
                            '2026-01-10': 'work',
                            '2026-01-11': 'business',    // 토요일
                            '2026-01-12': '41',          // 일요일
                            '2026-01-13': 'business',
                            '2026-01-14': 'business',
                            '2026-01-15': 'vacation',
                            '2026-01-16': 'vacation',
                            '2026-01-18': 'overseas',    // 토요일
                            '2026-01-19': 'overseas',    // 일요일
                            '2026-01-20': '41',
                            '2026-01-21': '41'
                        }
                    }
                };

                console.log('교사 5명 데이터 로드 완료');
                this.generateMainGrid();
                this.updateDisplay();
            }

            generateMainGrid() {
                const grid = document.getElementById('main-grid');

                // 날짜 헤더 생성
                let html = this.generateDateHeader();
                grid.innerHTML = html;
            }

            getSafeId(department) {
                return department.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            }

            generateDateHeader() {
                const dates = this.getVacationDates();
                let html = '<div class="teacher-name">교사명</div>';

                dates.forEach(date => {
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isHoliday = this.isHoliday(date);
                    const day = date.getDate();
                    const dayName = ['일', '월', '화', '수', '목', '금', '토'][date.getDay()];

                    const cssClass = isHoliday ? 'holiday' : (isWeekend ? 'weekend' : '');

                    html += `
                        <div class="date-cell ${cssClass}">
                            <div class="date-number">${day}</div>
                            <div class="date-day">${dayName}</div>
                        </div>
                    `;
                });

                return html;
            }

            getVacationDates() {
                const dates = [];
                const current = new Date(this.vacationStart);

                while (current <= this.vacationEnd) {
                    dates.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }

                return dates;
            }

            isHoliday(date) {
                return this.holidays.some(holiday =>
                    holiday.toDateString() === date.toDateString()
                );
            }

            updateDisplay() {
                this.updateDateGrid();
                document.getElementById('last-updated').textContent =
                    `마지막 업데이트: ${new Date().toLocaleString()}`;
            }

            updateDateGrid() {
                const grid = document.getElementById('main-grid');
                const dates = this.getVacationDates();

                console.log('업데이트 시작, 교사 수:', Object.keys(this.allSettings).length);
                console.log('날짜 수:', dates.length);

                // 날짜 헤더로 시작
                let html = this.generateDateHeader();

                // 모든 교사 표시 (부서 구분 없이)
                Object.keys(this.allSettings).forEach((teacherKey, index) => {
                    const teacherData = this.allSettings[teacherKey];
                    console.log(`교사 ${index + 1}: ${teacherData.name}`);
                    html += `
                        <div class="teacher-name">
                            <div class="teacher-info">
                                <div style="display: flex; align-items: center; gap: 4px; width: 100%;">
                                    <input type="checkbox" class="delete-checkbox" data-teacher-key="${teacherKey}" style="width: 14px; height: 14px; cursor: pointer;">
                                    <span style="flex: 1;">${teacherData.name}</span>
                                </div>
                                <div class="teacher-checkboxes">
                                    <div class="checkbox-row">
                                        <input type="checkbox" id="dept-${index}" onchange="handleAdminCheck(${index}, this.checked)">
                                        <label for="dept-${index}">교무</label>
                                    </div>
                                    <div class="checkbox-row">
                                        <input type="checkbox" id="research-${index}" onchange="handleResearchCheck(${index}, this.checked)">
                                        <label for="research-${index}">연구</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    dates.forEach((date, dateIndex) => {
                        const dateString = this.formatDateForStorage(date);
                        const schedule = teacherData.dutySchedule || {};
                        const detailSchedule = teacherData.detailSchedule || {};

                        const dutyType = schedule[dateString];
                        const detailInfo = detailSchedule[dateString];

                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                        const isHoliday = this.isHoliday(date);

                        const cellId = `cell-${index}-${dateIndex}`;

                        // 세부 시간 정보가 있는 경우 혼합 복무 체크
                        if (detailInfo && detailInfo.length > 0) {
                            // 주말 제외 플래그 확인
                            const isWeekendExcluded = detailInfo.some(slot => slot.isWeekendExcluded);

                            if (isWeekendExcluded) {
                                // 주말 제외 표시
                                html += `<div id="${cellId}" class="duty-cell duty-weekend-excluded" data-teacher="${index}" data-duty="weekend-excluded">제외</div>`;
                            } else {
                                // 시간순으로 정렬
                                const orderedSlots = detailInfo.sort((a, b) => a.start.localeCompare(b.start));
                                const dutyTypes = [...new Set(orderedSlots.map(slot => slot.type))]; // 중복 제거

                                if (dutyTypes.length === 1) {
                                    // 단일 복무 유형
                                    const singleType = dutyTypes[0];
                                    const typeName = this.getDutyTypeName(singleType);
                                    html += `<div id="${cellId}" class="duty-cell duty-${singleType}" data-teacher="${index}" data-duty="${singleType}" data-detail='${JSON.stringify(orderedSlots)}'>${typeName}</div>`;
                                } else if (dutyTypes.length > 1) {
                                    // 혼합 복무 유형 - 시간 비율 기반 분할
                                    html += this.createMixedDutyCell(orderedSlots, cellId, index);
                                }
                            }
                        } else if (dutyType) {
                            // 기본 복무 유형이 있는 경우 (주말/공휴일 관계없이 표시)
                            const typeName = this.getDutyTypeName(dutyType);
                            html += `<div id="${cellId}" class="duty-cell duty-${dutyType}" data-teacher="${index}" data-duty="${dutyType}">${typeName}</div>`;
                        } else if (isHoliday || isWeekend) {
                            // 복무 데이터가 없는 주말이나 공휴일
                            const cssClass = isHoliday ? 'holiday' : 'weekend';
                            html += `<div id="${cellId}" class="date-cell ${cssClass}" data-teacher="${index}"></div>`;
                        } else {
                            // 평일인데 복무 데이터가 없으면 기본 41조
                            html += `<div id="${cellId}" class="duty-cell duty-41" data-teacher="${index}" data-duty="41">41조</div>`;
                        }
                    });
                });

                console.log('HTML 길이:', html.length);
                grid.innerHTML = html;
                console.log('그리드 업데이트 완료');

                // 툴팁 이벤트 리스너 추가
                this.addTooltipListeners();
            }

            // 툴팁 이벤트 리스너 추가
            addTooltipListeners() {
                const cells = document.querySelectorAll('.duty-cell[data-detail]');

                cells.forEach(cell => {
                    cell.addEventListener('mouseenter', (e) => this.showTooltip(e));
                    cell.addEventListener('mouseleave', () => this.hideTooltip());
                });
            }

            // 툴팁 표시
            showTooltip(event) {
                const cell = event.currentTarget;
                const detailData = cell.getAttribute('data-detail');

                if (!detailData) return;

                try {
                    const slots = JSON.parse(detailData);

                    // 기존 툴팁 제거
                    this.hideTooltip();

                    // 툴팁 생성
                    const tooltip = document.createElement('div');
                    tooltip.className = 'duty-tooltip';
                    tooltip.id = 'duty-tooltip';

                    let tooltipHTML = '<div class="tooltip-title">📋 세부 시간 정보</div>';

                    slots.forEach(slot => {
                        const typeColor = this.getTypeColor(slot.type);
                        tooltipHTML += `
                            <div class="tooltip-time-slot">
                                <span class="tooltip-time">${slot.start} ~ ${slot.end}</span>
                                <span class="tooltip-type" style="background: ${typeColor};">
                                    ${this.getDutyTypeName(slot.type)}
                                </span>
                            </div>
                        `;
                    });

                    tooltip.innerHTML = tooltipHTML;
                    document.body.appendChild(tooltip);

                    // 위치 계산
                    const rect = cell.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();

                    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    let top = rect.top - tooltipRect.height - 10;

                    // 화면 밖으로 나가지 않도록 조정
                    if (left < 10) left = 10;
                    if (left + tooltipRect.width > window.innerWidth - 10) {
                        left = window.innerWidth - tooltipRect.width - 10;
                    }
                    if (top < 10) {
                        top = rect.bottom + 10; // 아래로 표시
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                } catch (error) {
                    console.error('툴팁 표시 오류:', error);
                }
            }

            // 툴팁 숨기기
            hideTooltip() {
                const tooltip = document.getElementById('duty-tooltip');
                if (tooltip) {
                    tooltip.remove();
                }
            }

            // 복무 유형별 색상 반환
            getTypeColor(type) {
                const colors = {
                    '41': '#4CAF50',
                    'work': '#2196F3',
                    'business': '#FF9800',
                    'vacation': '#F44336',
                    'overseas': '#9C27B0'
                };
                return colors[type] || '#666';
            }

            groupTeachersByDepartment() {
                const grouped = {};

                // 모든 부서 초기화
                this.departments.forEach(dept => {
                    grouped[dept] = [];
                });

                // 교사별로 부서에 배정
                Object.values(this.allSettings).forEach(teacherData => {
                    const department = teacherData.department;
                    if (department && grouped[department]) {
                        grouped[department].push(teacherData);
                    }
                });

                return grouped;
            }

            formatDateForStorage(date) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            }

            getDutyTypeName(type) {
                const types = {
                    '41': '41조',
                    'work': '근무',
                    'business': '출장',
                    'vacation': '연가',
                    'overseas': '국외',
                    'weekend-excluded': '제외'
                };
                return types[type] || '41조';
            }

            // 혼합 복무 처리 함수 (시간 비율 기반)
            createMixedDutyCell(orderedSlots, cellId, teacherIndex) {
                const dutyTypes = [...new Set(orderedSlots.map(slot => slot.type))];
                const typeNames = dutyTypes.map(type => this.getDutyTypeName(type)).join('+');

                const cell = document.createElement('div');
                cell.id = cellId;
                cell.className = 'duty-cell duty-mixed';
                cell.setAttribute('data-teacher', teacherIndex);
                cell.setAttribute('data-duty', 'mixed');
                cell.setAttribute('data-mixed-types', dutyTypes.join(','));
                cell.setAttribute('data-detail', JSON.stringify(orderedSlots));

                // 시간 비율 기반 분할 스타일 적용
                this.applyTimeBasedSplit(cell, orderedSlots);

                // 텍스트 추가
                const label = document.createElement('div');
                label.className = 'mixed-duty-label';
                label.textContent = typeNames;
                this.applyTimeBasedSplitToText(label, orderedSlots);
                cell.appendChild(label);

                return cell.outerHTML;
            }

            // 시간 비율 기반 분할 스타일 적용
            applyTimeBasedSplit(element, orderedSlots) {
                const colorMap = {
                    '41': 'rgba(76, 175, 80, 0.3)',
                    'work': 'rgba(33, 150, 243, 0.3)',
                    'business': 'rgba(255, 152, 0, 0.3)',
                    'vacation': 'rgba(244, 67, 54, 0.3)',
                    'overseas': 'rgba(156, 39, 176, 0.3)'
                };

                const borderMap = {
                    '41': '#4CAF50',
                    'work': '#2196F3',
                    'business': '#FF9800',
                    'vacation': '#F44336',
                    'overseas': '#9C27B0'
                };

                const totalMinutes = orderedSlots.reduce((sum, slot) => {
                    const start = this.timeToMinutes(slot.start);
                    const end = this.timeToMinutes(slot.end);
                    return sum + (end - start);
                }, 0);

                let gradientParts = [];
                let borderParts = [];
                let currentPercent = 0;

                orderedSlots.forEach(slot => {
                    const start = this.timeToMinutes(slot.start);
                    const end = this.timeToMinutes(slot.end);
                    const duration = end - start;
                    const percent = (duration / totalMinutes) * 100;

                    const color = colorMap[slot.type] || 'rgba(200, 200, 200, 0.3)';
                    const border = borderMap[slot.type] || '#ccc';

                    const startPercent = currentPercent;
                    const endPercent = currentPercent + percent;

                    gradientParts.push(`${color} ${startPercent}%`);
                    gradientParts.push(`${color} ${endPercent}%`);

                    borderParts.push(`${border} ${startPercent}%`);
                    borderParts.push(`${border} ${endPercent}%`);

                    currentPercent = endPercent;
                });

                element.style.background = `linear-gradient(to right, ${gradientParts.join(', ')})`;
                element.style.border = `2px solid`;
                element.style.borderImage = `linear-gradient(to right, ${borderParts.join(', ')}) 1`;
            }

            // 텍스트에 시간 비율 기반 분할 적용
            applyTimeBasedSplitToText(textElement, orderedSlots) {
                const colorMap = {
                    '41': 'rgba(76, 175, 80, 0.9)',
                    'work': 'rgba(33, 150, 243, 0.9)',
                    'business': 'rgba(255, 152, 0, 0.9)',
                    'vacation': 'rgba(244, 67, 54, 0.9)',
                    'overseas': 'rgba(156, 39, 176, 0.9)'
                };

                const totalMinutes = orderedSlots.reduce((sum, slot) => {
                    const start = this.timeToMinutes(slot.start);
                    const end = this.timeToMinutes(slot.end);
                    return sum + (end - start);
                }, 0);

                let gradientParts = [];
                let currentPercent = 0;

                orderedSlots.forEach(slot => {
                    const start = this.timeToMinutes(slot.start);
                    const end = this.timeToMinutes(slot.end);
                    const duration = end - start;
                    const percent = (duration / totalMinutes) * 100;

                    const color = colorMap[slot.type] || 'rgba(100, 100, 100, 0.9)';

                    const startPercent = currentPercent;
                    const endPercent = currentPercent + percent;

                    gradientParts.push(`${color} ${startPercent}%`);
                    gradientParts.push(`${color} ${endPercent}%`);

                    currentPercent = endPercent;
                });

                textElement.style.background = `linear-gradient(to right, ${gradientParts.join(', ')})`;
                textElement.style.color = 'white';
                textElement.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
            }

            // 시간 문자열을 분 단위로 변환
            timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            // 대각선 분할 스타일 적용 (index.html에서 가져온 로직)
            applyDiagonalSplit(element, dutyTypes) {
                const colorMap = {
                    '41': 'rgba(76, 175, 80, 0.3)',
                    'work': 'rgba(33, 150, 243, 0.3)',
                    'business': 'rgba(255, 152, 0, 0.3)',
                    'vacation': 'rgba(244, 67, 54, 0.3)',
                    'overseas': 'rgba(156, 39, 176, 0.3)'
                };

                const borderMap = {
                    '41': '#4CAF50',
                    'work': '#2196F3',
                    'business': '#FF9800',
                    'vacation': '#F44336',
                    'overseas': '#9C27B0'
                };

                if (dutyTypes.length === 2) {
                    // 2개 유형 - 대각선 분할
                    const color1 = colorMap[dutyTypes[0]] || 'rgba(200, 200, 200, 0.3)';
                    const color2 = colorMap[dutyTypes[1]] || 'rgba(200, 200, 200, 0.3)';
                    const border1 = borderMap[dutyTypes[0]] || '#ccc';
                    const border2 = borderMap[dutyTypes[1]] || '#ccc';

                    element.style.background = `linear-gradient(45deg, ${color1} 50%, ${color2} 50%)`;
                    element.style.border = `3px solid`;
                    element.style.borderImage = `linear-gradient(45deg, ${border1} 50%, ${border2} 50%) 1`;
                } else if (dutyTypes.length === 3) {
                    // 3개 유형 - 삼등분
                    const color1 = colorMap[dutyTypes[0]] || 'rgba(200, 200, 200, 0.3)';
                    const color2 = colorMap[dutyTypes[1]] || 'rgba(200, 200, 200, 0.3)';
                    const color3 = colorMap[dutyTypes[2]] || 'rgba(200, 200, 200, 0.3)';
                    const border1 = borderMap[dutyTypes[0]] || '#ccc';
                    const border2 = borderMap[dutyTypes[1]] || '#ccc';
                    const border3 = borderMap[dutyTypes[2]] || '#ccc';

                    element.style.background = `linear-gradient(45deg, ${color1} 33%, ${color2} 33%, ${color2} 66%, ${color3} 66%)`;
                    element.style.border = `3px solid`;
                    element.style.borderImage = `linear-gradient(45deg, ${border1} 33%, ${border2} 33%, ${border2} 66%, ${border3} 66%) 1`;
                } else {
                    // 4개 이상 - 체크무늬 패턴
                    const color1 = colorMap[dutyTypes[0]] || 'rgba(200, 200, 200, 0.3)';
                    const color2 = colorMap[dutyTypes[1]] || 'rgba(200, 200, 200, 0.3)';
                    const border1 = borderMap[dutyTypes[0]] || '#ccc';
                    const border2 = borderMap[dutyTypes[1]] || '#ccc';

                    element.style.background = `
                        repeating-linear-gradient(
                            45deg,
                            ${color1},
                            ${color1} 10px,
                            ${color2} 10px,
                            ${color2} 20px
                        )
                    `;
                    element.style.border = `3px solid`;
                    element.style.borderImage = `repeating-linear-gradient(45deg, ${border1}, ${border1} 5px, ${border2} 5px, ${border2} 10px) 1`;
                }
            }

            // 텍스트에 대각선 분할 스타일 적용
            applyDiagonalSplitToText(textElement, dutyTypes) {
                const colorMap = {
                    '41': 'rgba(76, 175, 80, 0.9)',
                    'work': 'rgba(33, 150, 243, 0.9)',
                    'business': 'rgba(255, 152, 0, 0.9)',
                    'vacation': 'rgba(244, 67, 54, 0.9)',
                    'overseas': 'rgba(156, 39, 176, 0.9)'
                };

                if (dutyTypes.length === 2) {
                    const color1 = colorMap[dutyTypes[0]] || 'rgba(100, 100, 100, 0.9)';
                    const color2 = colorMap[dutyTypes[1]] || 'rgba(100, 100, 100, 0.9)';

                    textElement.style.background = `linear-gradient(45deg, ${color1} 50%, ${color2} 50%)`;
                    textElement.style.color = 'white';
                    textElement.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                } else if (dutyTypes.length === 3) {
                    const color1 = colorMap[dutyTypes[0]] || 'rgba(100, 100, 100, 0.9)';
                    const color2 = colorMap[dutyTypes[1]] || 'rgba(100, 100, 100, 0.9)';
                    const color3 = colorMap[dutyTypes[2]] || 'rgba(100, 100, 100, 0.9)';

                    textElement.style.background = `linear-gradient(45deg, ${color1} 33%, ${color2} 33%, ${color2} 66%, ${color3} 66%)`;
                    textElement.style.color = 'white';
                    textElement.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                } else {
                    const color1 = colorMap[dutyTypes[0]] || 'rgba(100, 100, 100, 0.9)';
                    const color2 = colorMap[dutyTypes[1]] || 'rgba(100, 100, 100, 0.9)';

                    textElement.style.background = `
                        repeating-linear-gradient(
                            45deg,
                            ${color1},
                            ${color1} 5px,
                            ${color2} 5px,
                            ${color2} 10px
                        )
                    `;
                    textElement.style.color = 'white';
                    textElement.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';
                }
            }
        }

        // 전역 인스턴스
        let adminDashboard;

        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            adminDashboard = new AdminDashboard();
        });

        // 전역 함수들
        function refreshData() {
            adminDashboard.updateDisplay();
        }

        // 교무부장 체크박스 핸들러 (연가, 출장 빗금 처리)
        function handleAdminCheck(teacherIndex, isChecked) {
            const cells = document.querySelectorAll(`[data-teacher="${teacherIndex}"]`);

            cells.forEach(cell => {
                const dutyType = cell.getAttribute('data-duty');
                const mixedTypes = cell.getAttribute('data-mixed-types');

                // 단일 복무 유형 처리
                if (dutyType === 'vacation' || dutyType === 'business') {
                    if (isChecked) {
                        cell.classList.add('checked-by-admin');
                    } else {
                        cell.classList.remove('checked-by-admin');
                    }
                }

                // 혼합 복무 유형 처리
                if (dutyType === 'mixed' && mixedTypes) {
                    const typesArray = mixedTypes.split(',');
                    const hasAdminTypes = typesArray.some(type => type === 'vacation' || type === 'business');

                    if (hasAdminTypes) {
                        if (isChecked) {
                            cell.classList.add('checked-by-admin');
                        } else {
                            cell.classList.remove('checked-by-admin');
                        }
                    }
                }
            });
        }

        // 연구부장 체크박스 핸들러 (41조, 국외연수 빗금 처리)
        function handleResearchCheck(teacherIndex, isChecked) {
            const cells = document.querySelectorAll(`[data-teacher="${teacherIndex}"]`);

            cells.forEach(cell => {
                const dutyType = cell.getAttribute('data-duty');
                const mixedTypes = cell.getAttribute('data-mixed-types');

                // 단일 복무 유형 처리
                if (dutyType === '41' || dutyType === 'overseas') {
                    if (isChecked) {
                        cell.classList.add('checked-by-research');
                    } else {
                        cell.classList.remove('checked-by-research');
                    }
                }

                // 혼합 복무 유형 처리
                if (dutyType === 'mixed' && mixedTypes) {
                    const typesArray = mixedTypes.split(',');
                    const hasResearchTypes = typesArray.some(type => type === '41' || type === 'overseas');

                    if (hasResearchTypes) {
                        if (isChecked) {
                            cell.classList.add('checked-by-research');
                        } else {
                            cell.classList.remove('checked-by-research');
                        }
                    }
                }
            });
        }

        // Firebase 설정 함수들
        function showFirebaseSettings() {
            const modal = document.getElementById('firebaseModal');
            modal.style.display = 'flex';

            const apiKey = localStorage.getItem('firebase_apiKey');
            const projectId = localStorage.getItem('firebase_projectId');
            const savedSettingsInfo = document.getElementById('savedSettingsInfo');

            if (apiKey && projectId) {
                document.getElementById('firebaseApiKey').value = apiKey;
                document.getElementById('firebaseProjectId').value = projectId;
                savedSettingsInfo.style.display = 'block';
            } else {
                savedSettingsInfo.style.display = 'none';
            }
        }

        function saveFirebaseSettings() {
            const apiKey = document.getElementById('firebaseApiKey').value.trim();
            const projectId = document.getElementById('firebaseProjectId').value.trim();

            if (!apiKey || !projectId) {
                alert('API Key와 Project ID를 모두 입력해주세요.');
                return;
            }

            localStorage.setItem('firebase_apiKey', apiKey);
            localStorage.setItem('firebase_projectId', projectId);

            document.getElementById('firebaseModal').style.display = 'none';
            alert('Firebase 설정이 저장되었습니다!\n페이지를 새로고침합니다.');
            location.reload();
        }

        function closeFirebaseModal() {
            document.getElementById('firebaseModal').style.display = 'none';
        }

        // 선택된 교사 일괄 삭제
        function deleteSelectedTeachers() {
            if (!adminDashboard) return;

            const checkboxes = document.querySelectorAll('.delete-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('삭제할 교사를 선택해주세요.');
                return;
            }

            const teacherKeys = Array.from(checkboxes).map(cb => cb.getAttribute('data-teacher-key'));
            const teacherNames = teacherKeys.map(key => adminDashboard.allSettings[key]?.name).filter(Boolean);

            if (!confirm('다음 교사들의 데이터를 삭제하시겠습니까?\n\n' + teacherNames.join(', ') + '\n\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            if (!adminDashboard.firebaseEnabled || !adminDashboard.database) {
                alert('Firebase에 연결되어 있지 않습니다.\n삭제하려면 Firebase 설정을 완료해주세요.');
                return;
            }

            // Firebase에서 일괄 삭제
            const deletePromises = teacherKeys.map(key =>
                adminDashboard.database.ref('vacation-duty/' + key).remove()
            );

            Promise.all(deletePromises)
                .then(() => {
                    console.log('일괄 삭제 완료:', teacherKeys.length + '명');
                    alert(teacherKeys.length + '명의 교사 데이터가 삭제되었습니다.');
                })
                .catch((error) => {
                    console.error('삭제 실패:', error);
                    alert('데이터 삭제에 실패했습니다.\n\n' + error.message);
                });
        }
    </script>
</body>
</html>
